CREATE PROCEDURE [ZFP_SET_FUNCTION_GRPS](
	@P_FUNCTION_SEQ_ID INT,
	@P_SE_SEQ_ID INT,
	@P_GROUPS VARCHAR(1000),
	@P_PERMISSIONS_SEQ_ID INT,
	@P_ADDUPD_BY INT,
	@P_ErrorCode int OUTPUT
)
 AS
BEGIN TRAN
	-- NEED TO DELETE EXISTING ROLE ASSOCITAED WITH THE FUNCTION BEFORE 
	-- INSERTING NEW ONES.
	EXEC ZFP_DEL_FUNCTION_GRP_SECURITY @P_FUNCTION_SEQ_ID,@P_SE_SEQ_ID,@P_PERMISSIONS_SEQ_ID,@P_ADDUPD_BY,@P_ErrorCode
	SELECT @P_ErrorCode = @@error
	DECLARE @V_GROUP_SEQ_ID 		AS 	INT
	DECLARE @V_GRPS_SE_SEQ_ID 	AS 	INT
	DECLARE @V_GROUP_NAME		AS	VARCHAR(50)
	DECLARE @V_Pos 			AS	INT
	SET @P_GROUPS = LTRIM(RTRIM(@P_GROUPS))+ ','
	SET @V_Pos = CHARINDEX(',', @P_GROUPS, 1)
	IF LEN(REPLACE(@P_GROUPS, ',', '')) > 0
		WHILE @V_Pos > 0
		BEGIN
			SET @V_GROUP_NAME = LTRIM(RTRIM(LEFT(@P_GROUPS, @V_Pos - 1)))
			IF @V_GROUP_NAME <> ''
			BEGIN
				--select the role seq id first
				SELECT @V_GROUP_SEQ_ID = ZFC_SECURITY_GRPS.GROUP_SEQ_ID 
				FROM ZFC_SECURITY_GRPS 
				WHERE [NAME]=@V_GROUP_NAME

 				SELECT
					@V_GRPS_SE_SEQ_ID=GRPS_SE_SEQ_ID
				FROM
					ZFC_SECURITY_GRPS_SE
				WHERE
					GROUP_SEQ_ID = @V_GROUP_SEQ_ID AND
					SE_SEQ_ID = @P_SE_SEQ_ID
					--PRINT('@V_GRPS_SE_SEQ_ID = ' + CONVERT(VARCHAR,@V_GRPS_SE_SEQ_ID))
				IF NOT EXISTS(
						SELECT 
							GRPS_SE_SEQ_ID 
						FROM 
							ZFC_SECURITY_FUNCT_GRPS 
						WHERE 
						FUNCTION_SEQ_ID = @P_FUNCTION_SEQ_ID 
						AND PERMISSIONS_NVP_SEQ_DET_ID = @P_PERMISSIONS_SEQ_ID
						AND GRPS_SE_SEQ_ID = @V_GRPS_SE_SEQ_ID
				)
				BEGIN
					--PRINT('INSERT RECORD')
					INSERT ZFC_SECURITY_FUNCT_GRPS (
						FUNCTION_SEQ_ID,
						GRPS_SE_SEQ_ID,
						PERMISSIONS_NVP_SEQ_DET_ID,
						ADDED_BY
					)
					VALUES (
						@P_FUNCTION_SEQ_ID,
						@V_GRPS_SE_SEQ_ID,
						@P_PERMISSIONS_SEQ_ID,
						@P_ADDUPD_BY
					)
				END
		
			END
				SET @P_GROUPS = RIGHT(@P_GROUPS, LEN(@P_GROUPS) - @V_Pos)
				SET @V_Pos = CHARINDEX(',', @P_GROUPS, 1)
			SELECT @P_ErrorCode = @@error
		END
	IF @P_ErrorCode <> 0 GOTO ABEND
COMMIT TRAN
	ABEND:
IF @P_ErrorCode <> 0
	BEGIN
		PRINT 'Yikes!'
		ROLLBACK TRAN
	END
